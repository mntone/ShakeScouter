# Copyright (C) 2024 mntone
# Licensed under the GPLv3 license.

from parameterized import parameterized
from unittest import TestCase

from utils.anomaly import CounterAnomalyDetector

class TestCounterAnomalyDetector(TestCase):
	@parameterized.expand([
		(
			[
				[100, -9.99959397315979],
				[100, -9.166397333145142],
				[100, -8.333528757095337],
				[100, -7.500119924545288],
				[100, -6.666104316711426],
				[100, -5.8331615924835205],
				[100, -4.99959659576416],
				[100, -4.1662514209747314],
				[100, -3.333444356918335],
				[100, -2.499494791030884],
				[100, -1.6662089824676514],
				[100, -0.833216667175293],
				[100, 0.0],
				[99, 0.8337957859039307],
				[98, 1.6663386821746826],
				[98, 2.500213861465454],
				[97, 3.3337693214416504],
				[96, 4.166370391845703],
				[95, 4.999556064605713],
				[94, 5.8332130908966064],
				[93, 6.666690826416016],
				[93, 7.49963903427124],
				[92, 8.333932161331177],
				[91, 9.166738748550415],
				[90, 9.99977707862854],
				[89, 10.833737850189209],
				[88, 11.666526556015015],
				[88, 12.499664545059204],
				[87, 13.333216190338135],
				[86, 14.166579484939575],
				[85, 14.999618768692017],
				[84, 15.833714246749878],
				[83, 16.666780710220337],
				[83, 17.499724626541138],
				[82, 18.333616018295288],
				[81, 19.167038679122925],
				[80, 19.99994969367981],
				[79, 20.833527088165283],
				[78, 21.666225910186768],
				[78, 22.500516653060913],
				[77, 23.333682537078857],
				[76, 24.16645908355713],
				[75, 24.999945640563965],
				[74, 25.832865953445435],
				[73, 26.66634702682495],
				[73, 27.499704599380493],
				[72, 28.333400011062622],
				[71, 29.166497230529785],
				[70, 30.000500202178955],
				[69, 30.83379554748535],
				[68, 31.666807889938354],
				[68, 32.50041913986206],
				[67, 33.33379101753235],
				[66, 34.16684317588806],
				[65, 34.99974012374878],
				[64, 35.83379006385803],
				[63, 36.66628384590149],
				[63, 37.49959444999695],
				[62, 38.33348774909973],
				[61, 39.166226625442505],
				[60, 39.9996132850647],
				[59, 40.83324646949768],
				[58, 41.66651129722595],
				[58, 42.499645709991455],
				[57, 43.33269286155701],
				[56, 44.166491746902466],
				[55, 44.99959993362427],
				[54, 45.833340883255005],
				[53, 46.667070150375366],
				[53, 47.500197887420654],
				[52, 48.33326816558838],
				[51, 49.167179584503174],
				[50, 50.00005888938904],
				[49, 50.83308410644531],
				[48, 51.666624546051025],
				[48, 52.49954056739807],
				[47, 53.333168029785156],
				[46, 54.16689658164978],
				[45, 55.00017476081848],
				[44, 55.8338782787323],
				[43, 56.66696357727051],
				[43, 57.50023555755615],
				[42, 58.333409547805786],
				[41, 59.166468381881714],
				[40, 60.00010061264038],
				[39, 60.83339071273804],
				[38, 61.666781425476074],
				[38, 62.500535011291504],
				[37, 63.3331036567688],
				[36, 64.16687297821045],
				[35, 64.99992799758911],
				[34, 65.83379530906677],
				[33, 66.66633582115173],
				[33, 67.49977588653564],
				[32, 68.33354687690735],
				[31, 69.16684699058533],
				[30, 70.00043201446533],
				[29, 70.83374214172363],
				[28, 71.66711616516113],
				[28, 72.4995436668396],
				[27, 73.33372282981873],
				[26, 74.16690826416016],
				[25, 75.00015783309937],
				[24, 75.83314204216003],
				[23, 76.66647362709045],
				[23, 77.50011587142944],
				[22, 78.33372187614441],
				[21, 79.16669583320618],
				[20, 80.00031208992004],
				[19, 80.83307456970215],
				[18, 81.666170835495],
				[18, 82.50025987625122],
				[17, 83.33353543281555],
				[16, 84.16659760475159],
				[15, 84.99956202507019],
				[2, 85.8330192565918],
				[13, 86.66698050498962],
				[13, 87.50000214576721],
				[4, 88.33297967910767],
				[11, 89.16650438308716],
				[10, 89.99994683265686],
				[9, 90.8332588672638],
				[8, 91.66642332077026],
				[8, 92.50033903121948],
				[7, 93.33308696746826],
				[5, 94.16695833206177],
				[5, 95.00036787986755],
				[4, 95.8328607082367],
				[3, 96.66702198982239],
				[3, 97.50025057792664],
				[2, 98.33333826065063],
				[1, 99.16665244102478],
				[0, 100.00033712387085],
				[0, 100.832843542099],
				[0, 101.66577482223511],
				[0, 102.49975395202637],
				[0, 103.33373379707336],
				[0, 104.16647481918335],
			],
			[85.8330192565918, 88.33297967910767],
		),
		(
			[
				[100, -10.000469207763672],
				[100, -9.166468858718872],
				[100, -8.333007574081421],
				[100, -7.50049901008606],
				[100, -6.667018175125122],
				[100, -5.83296012878418],
				[100, -4.999768257141113],
				[100, -4.166951417922974],
				[100, -3.3330259323120117],
				[100, -2.4999940395355225],
				[100, -1.667020320892334],
				[100, -0.8338637351989746],
				[100, 0.0],
				[99, 0.8327929973602295],
				[99, 1.6668999195098877],
				[98, 2.499868392944336],
				[97, 3.3329553604125977],
				[96, 4.166524410247803],
				[95, 5.000147581100464],
				[94, 5.832742214202881],
				[94, 6.666311979293823],
				[93, 7.499927043914795],
				[92, 8.333774089813232],
				[91, 9.166695356369019],
				[90, 10.000726461410522],
				[89, 10.833256006240845],
				[89, 11.66675615310669],
				[88, 12.500152587890625],
				[87, 13.333234548568726],
				[86, 14.166181087493896],
				[85, 15.00019121170044],
				[84, 15.833148002624512],
				[84, 16.66665291786194],
				[83, 17.499715328216553],
				[82, 18.333115339279175],
				[81, 19.16697645187378],
				[80, 20.00027108192444],
				[79, 20.83284306526184],
				[79, 21.666719913482666],
				[78, 22.49914860725403],
				[77, 23.332770347595215],
				[76, 24.16685175895691],
				[75, 24.999971389770508],
				[74, 25.833527326583862],
				[74, 26.666510343551636],
				[73, 27.499489784240723],
				[72, 28.33331298828125],
				[71, 29.166133403778076],
				[70, 29.999613761901855],
				[69, 30.83282232284546],
				[69, 31.66623330116272],
				[68, 32.49967932701111],
				[67, 33.332887172698975],
				[66, 34.16605043411255],
				[65, 34.999417304992676],
				[64, 35.83295392990112],
				[64, 36.666847229003906],
				[63, 37.499964475631714],
				[62, 38.33343768119812],
				[61, 39.16630578041077],
				[60, 39.99962759017944],
				[59, 40.83287525177002],
				[59, 41.666258811950684],
				[58, 42.49937915802002],
				[57, 43.33248710632324],
				[56, 44.16627907752991],
				[55, 45.000251054763794],
				[54, 45.83334684371948],
				[54, 46.666226387023926],
				[53, 47.49967980384827],
				[52, 48.3335919380188],
				[51, 49.16666865348816],
				[50, 49.99965500831604],
				[49, 50.8331573009491],
				[49, 51.66641187667847],
				[48, 52.50014686584473],
				[47, 53.33260488510132],
				[46, 54.16659998893738],
				[45, 54.999324321746826],
				[44, 55.83270287513733],
				[44, 56.66606616973877],
				[43, 57.50003957748413],
				[42, 58.332701206207275],
				[41, 59.1655969619751],
				[40, 59.99971580505371],
				[39, 60.833492279052734],
				[39, 61.66648817062378],
				[38, 62.49949526786804],
				[37, 63.33294177055359],
				[36, 64.16663336753845],
				[35, 65.00023031234741],
				[34, 65.83301305770874],
				[34, 66.66691255569458],
				[33, 67.49969148635864],
				[32, 68.33345437049866],
				[31, 69.16671538352966],
				[29, 70.83353042602539],
				[9, 71.6668450832367],
				[28, 72.49950408935547],
				[27, 73.33332347869873],
				[26, 74.16599297523499],
				[25, 75.0002269744873],
				[9, 75.8332998752594],
				[24, 76.66656041145325],
				[23, 77.49976420402527],
				[22, 78.33281326293945],
				[21, 79.16677284240723],
				[20, 79.99915385246277],
				[19, 80.83342790603638],
				[19, 81.66619801521301],
				[18, 82.49921727180481],
				[17, 83.33329176902771],
				[16, 84.16608119010925],
				[15, 84.99971008300781],
				[14, 85.83288049697876],
				[14, 86.66610026359558],
				[13, 87.49974632263184],
				[12, 88.33338236808777],
				[11, 89.1662130355835],
				[10, 89.99975848197937],
				[9, 90.8330328464508],
				[9, 91.66647601127625],
				[8, 92.49932909011841],
				[7, 93.33297491073608],
				[6, 94.1666157245636],
				[5, 94.99968099594116],
				[4, 95.83270788192749],
				[4, 96.66652202606201],
				[3, 97.49998545646667],
				[2, 98.33225059509277],
				[1, 99.16590976715088],
				[0, 99.99994993209839],
				[0, 100.83359169960022],
				[0, 101.6663830280304],
				[0, 102.50000619888306],
				[0, 103.33292078971863],
				[0, 104.16600775718689],
				[1, 104.99955916404724],
			],
			[71.6668450832367, 75.8332998752594, 104.99955916404724]
		),
		(
			[
				[100, -9.83177137374878],
				[99, 1.0],
				[98, 1.8323359489440918],
				[97, 2.6657660007476807],
				[96, 3.4986374378204346],
				[95, 5.173630237579346],
				[94, 6.004335880279541],
				[93, 6.836629152297974],
				[92, 7.669442415237427],
				[91, 8.499587059020996],
				[90, 10.163052082061768],
				[89, 10.994732141494751],
				[88, 11.84212350845337],
				[87, 12.674668073654175],
				[86, 13.503070831298828],
				[86, 14.33357548713684],
				[85, 15.165658712387085],
				[84, 15.996601343154907],
				[83, 16.84104633331299],
				[82, 17.673967838287354],
				[81, 18.505588054656982],
				[81, 19.33738374710083],
				[80, 20.167714834213257],
				[79, 20.998133659362793],
				[78, 21.841870546340942],
				[77, 22.666290521621704],
				[76, 23.498884439468384],
				[76, 24.330353260040283],
				[75, 25.174476385116577],
				[74, 26.007392406463623],
				[73, 26.83190155029297],
				[72, 27.66579556465149],
				[71, 28.49569344520569],
				[71, 29.34134006500244],
				[70, 30.172213077545166],
				[69, 31.00361919403076],
				[68, 31.83423352241516],
				[67, 32.66175723075867],
				[66, 33.503803968429565],
				[66, 34.334636926651],
				[65, 35.16662406921387],
				[64, 35.995591163635254],
				[63, 36.841320753097534],
				[62, 37.672080516815186],
				[61, 38.50305104255676],
				[60, 40.16189384460449],
				[59, 41.00792908668518],
				[58, 41.836955308914185],
				[57, 42.673187255859375],
				[56, 43.50653338432312],
				[56, 44.34007692337036],
				[55, 45.16150259971619],
				[54, 45.995060205459595],
				[53, 46.83952307701111],
				[52, 47.6740608215332],
				[51, 48.50541830062866],
				[50, 50.167460918426514],
				[49, 50.997944355010986],
				[48, 51.8332154750824],
				[47, 52.6650128364563],
				[46, 53.494863986968994],
				[46, 54.327882289886475],
				[45, 55.17431592941284],
				[44, 56.00736856460571],
				[43, 56.83941173553467],
				[42, 57.6728310585022],
				[41, 58.50354266166687],
				[40, 60.174055099487305],
				[39, 61.00430154800415],
				[38, 61.833369731903076],
				[37, 62.66885566711426],
				[36, 63.5014123916626],
				[36, 64.33040642738342],
				[35, 65.17480993270874],
				[34, 65.99971556663513],
				[33, 66.83008670806885],
				[32, 67.66186046600342],
				[31, 68.50574040412903],
				[31, 69.33960103988647],
				[30, 70.16871666908264],
				[29, 71.00305438041687],
				[28, 71.83325147628784],
				[27, 72.66162657737732],
				[26, 73.50669407844543],
				[25, 75.17343974113464],
				[24, 76.0036735534668],
				[23, 76.83105206489563],
				[22, 77.66554284095764],
				[21, 78.49953722953796],
				[21, 79.34001564979553],
				[20, 80.17200779914856],
				[19, 81.00039672851562],
				[18, 81.83548665046692],
				[17, 82.6724534034729],
				[16, 83.49545907974243],
				[16, 84.32945585250854],
				[15, 85.17443132400513],
				[14, 86.00343918800354],
				[13, 86.83518052101135],
				[12, 87.66339325904846],
				[11, 88.49843764305115],
				[11, 89.3306052684784],
				[10, 90.16412591934204],
				[9, 90.99512767791748],
				[8, 91.8283622264862],
				[7, 92.66152286529541],
				[6, 93.50512409210205],
				[9, 94.33098673820496],
				[5, 95.16238832473755],
				[4, 95.99635195732117],
				[3, 96.82930159568787],
				[2, 97.6636233329773],
				[1, 98.49667525291443],
				[1, 99.3276948928833],
				[0, 100.17209839820862],
				[0, 104.3283965587616],
				[100, 110.17407751083374],
			],
			[94.33098673820496]
		),
	])
	def test(self, input: list[tuple[int, float]], anomalyValues: list[float]):
		detector = CounterAnomalyDetector()
		for [count, timestamp] in input:
			ret = detector.isAnomalous(count, timestamp)
			self.assertEqual(ret, timestamp in anomalyValues, timestamp)
